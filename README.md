# 📊 이상치 거래 탐지 시스템

## 프로젝트 개요
### 👥구성원
<table>
  <tr>
    <td align="center">
      <a href="https://github.com/moonstone0514">
        <img src="https://github.com/moonstone0514.png" width="100px;" alt="moonstone0514"/><br />
        <sub><b>김문석</b></sub>
      </a>
    </td>
    <td align="center">
      <a href="https://github.com/Hyunsoo1998">
        <img src="https://github.com/Hyunsoo1998.png" width="100px;" alt="Hyunsoo1998"/><br />
        <sub><b>김현수</b></sub>
      </a>
    </td>
<td align="center">
      <a href="https://github.com/GIHYUN-LEE">
        <img src="https://github.com/GIHYUN-LEE.png" width="100px;" alt="GIHYUN-LEE"/><br />
        <sub><b>이기현</b></sub>
      </a>
    </td>
    <td align="center">
      <a href="https://github.com/GodNowoon">
        <img src="https://github.com/GodNowoon.png" width="100px;" alt="godnowoon"/><br />
        <sub><b>이노운</b></sub>
      </a>
    </td>
  </tr>
</table>


**이상치 거래 탐지 시스템**을 구축하여 금융 및 결제 데이터에서 발생하는 **비정상적인 소비 패턴**을 실시간으로 탐지하고, **보험사기**, **자금세탁**, **허위 청구** 등의 고위험 거래를 예방하는 시스템을 개발하였습니다. 이를 기반으로 **금융당국**과 협력하여 **위험 요소를 사전에 차단**하는 것을 목표로 합니다. **Kibana**를 사용하여 데이터를 시각화하고, 이상 거래를 모니터링합니다.



---

## 🔎 이상치 거래 사례

### 1. **연령대별 비정상적 고액 사용 (20대의 보험/병원 비용 급증 사례)**  
20대 고객이 평균 대비 수십 배의 보험료나 병원비를 결제하는 이상 패턴으로, **허위 진료**를 통한 **보험금 편취**가 의심됩니다.  
[관련 뉴스 링크](https://www.donga.com/news/Society/article/all/20250309/131169088/1)

### 2. **고위험 업종에 대한 집중 결제 (6개월 소비의 95%를 특정 업종에 사용)**  
일부 고객이 **고위험 업종**(예: 고가 골프클럽, 유흥주점 등)에 소비를 집중하는 경우, **자금세탁**이나 **불법 자금 유용**의 가능성이 있습니다.  
[관련 뉴스 링크](https://www.chosun.com/national/national_general/2024/12/13/IYYEIYMYDNDOXO5M6KF34CVQZM/)

### 3. **고령층의 고액 통신판매 피해 (모르는 사이 휴대폰 개통 피해 사례)**  
고령층 고객이 자신도 모르는 사이 **휴대전화 개통** 등 **대포폰 개설 범죄**에 연루되는 사례입니다.  
[관련 뉴스 링크](https://mobile.busan.com/view/youngman/view.php?code=2025042810225886776)

### 4. **지역별 특정 업종 과소비 (자동차 수리비 과다 청구 사례)**  
특정 지역에서 자동차 수리 서비스 분야의 과도한 소비가 발견되는 경우, **허위 수리비 청구**로 인한 **보험사기**일 수 있습니다.  
[관련 뉴스 링크](https://www.moneys.co.kr/article/2025071016030771273)


---

## 🗂️ 이상치 거래 데이터 시나리오 목록

| 시나리오              | 업종/유형         | 주요 특징                   | 잠재적 위험          |
| ----------------- | ------------- | ----------------------- | --------------- |
| ① 연령대별 비정상적 고액 사용 | 보험/병원         | 20대가 평균 대비 수십 배 보험료 결제  | 보험 사기, 가족 대리결제  |
| ② 고위험 업종 집중 결제    | 회원제형태업소(골프 등) | 6개월 소비의 95%를 고위험 업종에 집중 | 자금세탁, 불법 자금     |
| ③ 고령층의 고액 통신판매    | 사무/통신기기       | 80대가 고액 결제 지속           | 타인 명의 사용, 대포카드  |
| ④ 지역별 특정 업종 과소비   | 자동차 수리서비스     | 특정 지역에서 수리비 과다          | 허위 수리비 청구, 보험사기 |

---

## 📋 이상치 데이터 상세

# 🔎 시나리오 ① 연령대별 비정상적 고액 사용 (보험)

| 항목 | 값 |
| ---- | --- |
| **기준시점** | 2023년 2분기 |
| **고객번호** | I7TB1AQ57ACJ2FGX0LWA (예시값) |
| **연령대** | 20 (20~24세) |
| **성별** | 남성 |
| **거주지역** | 강원 |
| **총 이용금액** | 8,343,200원 |
| **업종** | 보험/병원 > 보험 |

**이유:**  
20대 남성은 일반적으로 **보험 이용이 적고 고액 지출도 드문 편**인데,
해당 고객은 **평균보다 수십 배 많은 금액**을 사용해
통계적으로 매우 이례적인 **이상치**로 탐지되었습니다.


---

## 📈 Kibana 시각화 설명

![20대 보험비](<20대 보험비.png>)

위 그래프는 **Kibana**에서 아래 조건으로 필터링 후 시각화한 결과입니다.  
`연령대 = 20대` & `업종 = 보험/병원 > 보험` 조건을 적용하여  
**고객별 보험비 사용 패턴(평균·최대)** 을 비교한 것입니다.

---

### ✅ 축 설정
- **X축 (가로)** : 사용자 ID값  
  각 개별 고객을 구분하기 위한 ID 값이 나열됩니다.
- **Y축 (세로)** : 보험비 금액  
  선택한 고객들의 **보험비 사용 금액**을 기준으로, 평균과 최댓값을 각각 표시합니다.

---

### ✅ 집계 방식
- **🟢 보험비 평균값** : 각 고객별 보험비 사용 금액의 평균
- **🟣 보험비 최댓값** : 각 고객별 보험비 사용 금액 중 가장 큰 값

---

### 📌 그래프에서 읽을 수 있는 포인트
- 대부분의 고객은 낮은 금액 범위에 분포하지만,  
  일부 고객 ID에서 **평균과 최대 보험비가 비정상적으로 급등**하는 지점이 보입니다.
- 보라색(최댓값)이 초록색(평균값)보다 훨씬 큰 피크가 발생하는 구간은  
  → **특정 고객이 한 번에 매우 큰 금액을 사용한 이상치 패턴**을 나타냅니다.

---

**✅ 결론:**  
시각화를 통해 20대 고객 중 `보험/병원 > 보험` 업종에서  
**비정상적 고액 사용 패턴**을 한눈에 파악할 수 있습니다.

---

# 🔎 시나리오 ② 고위험 업종 집중 결제

| 항목 | 값 |
| ---- | --- |
| **기준시점** | 2023년 2분기 |
| **고객번호** | CIMR4AHYWW91XJNU42SS (예시값) |
| **연령대** | 45 (45~49세) |
| **성별** | 남성 |
| **거주지역** | 경북 |
| **총 이용금액** | 1,000,000,000원 |
| **업종** | 여행/레저/문화 > 회원제형태업소 |

**이유:** 
특정 고객이 전체 이용금액의 **95%를 고위험 업종(회원제 형태 업소)** 에 **집중 결제**하여  
**비정상적인 이상치 패턴**으로 탐지되었습니다.

---

## 📈 Kibana 시각화 설명

![골프장](<./골프장.png>)

위 그래프는 **Kibana**에서 `업종 = 여행/레저/문화 > 회원제형태업소` 조건을 적용하여  
**사용자별 이용금액**을 시각화한 결과입니다.

---

### ✅ 축 설정
- **X축 (가로)** : `사용자 ID값`  
  각 개별 고객을 구분하기 위한 ID 값이 나열됩니다.
- **Y축 (세로)** : `회원제 형태 업소 사용 금액`  
  각 고객이 해당 업종에서 사용한 금액을 기준으로 표시합니다.

---

### ✅ 집계 방식
- **🟢 평균 회원제 형태 업소 사용 금액** : 고객별 평균 사용 금액
- **🔵 최대 회원제 형태 업소 사용 금액** : 고객별 최대 사용 금액

---

### 📌 그래프에서 읽을 수 있는 포인트
- 대부분의 고객은 해당 업종에서 소액 사용에 머물러 있지만,
- 특정 고객 ID에서 **평균과 최대 사용 금액이 급격히 치솟는 피크**가 보입니다.
- 특히 최댓값(🔵)이 700 이상으로 치솟는 구간은, **특정 고객이 고위험 업종에 매우 높은 금액을 집중 사용**했음을 보여줍니다.

---

**✅ 결론:**  
이 시각화를 통해, **고위험 업종에서 비정상적으로 높은 결제 금액**을 기록한 고객을 쉽게 식별할 수 있습니다.


---

# 🔎 시나리오 ③ 고령층의 고액 통신판매

| 항목 | 값 |
| ---- | --- |
| **기준시점** | 2023년 1분기 |
| **고객번호** | 6W0DKXZER6S5S4JZ4WVJ (예시값) |
| **연령대** | 80 (80~84세) |
| **성별** | 여성 |
| **거주지역** | 경기 |
| **총 이용금액** | 634,000,000원 |
| **업종** | 사무통신/서적/학원 > 사무/통신기기 |

**이유:**  
고령층에서는 보기 힘든 **고액·반복적 결제** 패턴으로,  
통상 수십만~수백만 원 수준을 훨씬 뛰어넘는 **이상치**로 탐지되었습니다.

---

## 📈 Kibana 시각화 결과

![80대 노인 통신비](<./80대 노인 통신비.png>)

위 그래프는 `연령대 = 80대` & `업종 = 사무통신/서적/학원 > 사무/통신기기` 조건을 필터링하여  
**각 사용자 ID별 통신기기 사용금액**을 시각화한 것입니다.

---

### ✅ 축 설명

- **X축 (가로)** : 사용자 ID값  
  80대 고객별로 고유 식별값을 나열합니다.

- **Y축 (세로)** : 통신기기 사용금액  
  각 회원의 특정 기간 동안의 **총 카드 사용 금액(원 단위)** 을 표시합니다.

---

### 📌 그래프에서 읽을 수 있는 포인트

- 대부분 고객은 통신기기 사용금액이 1~2 수준으로 낮게 유지되지만,
- 양 끝단에 위치한 일부 고객에서 **비정상적으로 높은 사용금액**이 나타납니다.
- 특히 오른쪽 끝단 고객에서 5에 가까운 값으로 급등하는 구간이 보이며,
  이는 **반복적이거나 고액 결제 패턴**으로, **이상치(Outlier)** 로 탐지됩니다.

---

**✅ 결론:**  
이 시각화를 통해, 80대 고객 중 **사무/통신기기 업종에서 고액·반복적 사용**을 한 고객을  
쉽게 식별할 수 있습니다.

---

### 🔍 분석 포인트

- 다수의 80대 회원은 미미한 금액을 사용하지만,
- 특정 회원(쓰레기값으로 보이는 고객번호)에서 **5000 만원대** 결제가 집중 발생.
- 이는 고령층에서 드물게 나타나는 고액·반복 결제 패턴으로,  
  **대리점 사기·대포폰 개통 등 범죄 연루 가능성**을 시사합니다.

---

# 🔎 시나리오 ④ 지역별 특정 업종 과소비 (자동차 튜닝)

| 항목 | 값 |
| ---- | --- |
| **기준시점** | 2023년 1분기 |
| **고객번호** | 1XHW7KY657UGWUPFR87X |
| **연령대** | 40 (40~44세) |
| **성별** | 남성 |
| **거주지역** | 전남 |
| **총 이용금액** | 50,000,000원 |
| **업종** | 자동차/연료/정비 > 수리서비스 |

**이유:**  
해당 지역 평균 대비 **수리·튜닝 과다 지출**이 확인되어 **이상치**로 탐지되었습니다.

---

## 📈 Kibana 시각화 결과

![차량 수리비](<./차량 수리비.png>)

위 그래프는 `업종 = 자동차/연료/정비 > 수리서비스` 조건을 적용하여  
**사용자 ID별 차량 수리비 사용 금액**을 시각화한 것입니다.

---

### ✅ 축 설명

- **X축 (가로)** : 사용자 ID값  
  각 고객의 고유 식별값이 나열됩니다.

- **Y축 (세로)** : 차량 수리비  
  해당 고객이 특정 기간 동안 지출한 **차량 수리·튜닝 비용**을 표시합니다.

---

### 📌 그래프에서 읽을 수 있는 포인트

- 대부분의 고객은 차량 수리비 지출이 0~2 수준으로 낮게 나타납니다.
- 그러나 일부 고객 ID에서 **수리비 지출이 급격히 증가**한 피크가 관찰됩니다.
- 특히 오른쪽 끝단의 특정 고객에서 **수십 단위의 지출**이 확인되어,
  지역 평균 대비 **비정상적 과소비(이상치)** 로 탐지됩니다.

---

## ⚡ Kibana를 통한 이상치 거래 탐지

이상치 거래 데이터를 **Kibana**에서 시각화하여 분석하고,  
특정 패턴을 실시간으로 모니터링합니다.  
이를 통해 **금융당국**과 협력하여 **위험 요소를 사전에 차단**하는 데 활용할 수 있습니다.

### 🚀 파이프라인 구축 및 실행
<img width="941" height="86" alt="그림 drawio" src="https://github.com/user-attachments/assets/51d941eb-830c-4a2e-b707-95bdffdee7a5" />


**1. filebeat를 이용한 데이터 수집**
- filebeat.yml **input** 설정
 ```yml
filebeat.inputs:
- type: log
  enabled: true
  paths:
    - C:\ce5\00.dataSet\edu_data_F.csv
  exclude_lines: ['^컬럼명']
```
  
| 항목                 | 설정 값 / 설명                                       |
| ------------------ | ----------------------------------------------- |
| **type**           | `log` - 로그 파일을 읽는 input 모듈                      |
| **enabled**        | `true` - input 활성화                              |
| **paths**          | `C:\ce5\00.dataSet\edu_data_F.csv` - 읽어들일 파일 경로(우리카드 raw data) |
| **exclude\_lines** | `['^컬럼명']` - csv 헤더 줄 제외                  |
<br>

 - filebeat.yml **output** 설정

1) Elasticsearch Output (**비활성화**)

```yaml
# output.elasticsearch:
# hosts: ["localhost:9200"]
```

* 현재 **주석 처리**되어 비활성화
* Filebeat가 데이터를 **직접 Elasticsearch로 전송**하는 설정

 2) Logstash Output (**활성화**)

```yaml
output.logstash:
hosts: ["localhost:5044"]
```

* Filebeat가 수집한 데이터를 **Logstash로 전달**
* Logstash에서 추가 가공/변환 후 Elasticsearch 등으로 전송 가능


<br>

**2. logstash를 이용한 데이터 필터링**

```yml
input {
  beats {
    port => 5044
  }
}

# message 인덱스 5, 7, 8, 9 제외 
filter {
  mutate {
    split => ["message", ","]
    add_field => {
      "컬럼명1"              => "%{[message][0]}"
      "컬럼명2"              => "%{[message][1]}
        ... 
      "컬럼명54"             => "%{[message][53]}"
      "컬럼명55"             => "%{[message][54]}"
    }

# message 필드 삭제
    remove_field => ["ecs", "host", "@version", "agent", "log", "tags", "input", "message"]
  }

  mutate {
    convert => {
      "컬럼명" => "integer"
    }
    remove_field => [ "@timestamp" ]
  }
}

output {
  stdout {
    codec => rubydebug
  }

  elasticsearch {
    hosts => ["http://localhost:9200"]
    index => "cardfisa"
  }
}
```

| 구분       | 항목                        | 설정 값 / 설명 |
|------------|-----------------------------|----------------|
| **input**  |  port                        | `5044` - beats 연결용 포트 |
| **filter** | mutate - split              | `"message", ","` - message 값을 쉼표 기준으로 분할 |
|            | mutate - add_field          | `컬럼명1` ~ `컬럼명55` 추가 (`message` 배열의 각 인덱스 값 매핑)<br>※ message 인덱스 5, 7, 8, 9 제외<br>(**이상치 데이터에 맞도록 데이터 필터링**) |
|            | mutate - remove_field       | `["ecs", "host", "@version", "agent", "log", "tags", "input", "message","@timestamp"]` 삭제 |
|            | mutate - convert            | `"컬럼명"` 필드 → `integer` 형변환 |
| **output** | stdout - codec              | `rubydebug` - 콘솔에 디버그 형태로 출력 |
|            | elasticsearch - hosts       | `http://localhost:9200` - Elasticsearch 주소 |
|            | elasticsearch - index       | `cardfisa` - 저장할 인덱스명 |




## 🗑️ **삭제한 컬럼**

- **삭제 사유:**  
  데이터 분석 및 모델링 과정에서 **이상치 탐지와 직접적인 상관성이 낮고, 시각화 및 분석 결과에 영향을 미치지 않는 것으로 확인된 컬럼**들을 삭제하였습니다.

- **삭제 근거:**  
  - **Kibana 시각화 검증:**  
    해당 컬럼들을 포함한 경우와 제외한 경우를 비교한 결과, **시각화 지표에 영향을 미치지 않는 것이 확인**되었습니다.
<br>


**3. 이상치 데이터 삽입**  
   샘플 데이터를 기반으로 **이상치 거래 데이터**를 생성하여 **Elasticsearch**에 삽입합니다.
   
<br>

**4. Kibana 대시보드 설정**  
   Kibana를 통해 실시간으로 거래 데이터를 시각화하고,  
   **이상치 패턴**을 탐지할 수 있는 대시보드를 구성합니다.
   <img width="1898" height="1400" alt="화면 캡처 2025-07-18 111217" src="https://github.com/user-attachments/assets/98b2798b-fba9-4d78-be3d-943ec08767f6" />

---
## ⚠️ **트러블 슈팅**

### 이상치 데이터 입력 오류
- 현상 : ElasticSearch에 정제한 데이터를 입력한 이후 이상치 데이터 값을 삽입했는데 출력값이 달랐습니다.
- 원인 : Raw 데이터에 정제한 스키마에 따라 데이터를 입력해서 데이터가 다른 컬럼에 입력되었습니다.
- 해결 : 데이터 정제는 logstash의 역할이므로 Raw 데이터에 이상치 입력 시 기존 스키마에 따라 입력했습니다.

---
## 👥 **회고**


- **시나리오 구체화 부족:**  
  분석 목적에 맞는 **시나리오가 조금 더 구체적이었다면**, 원하는 데이터를 더 잘 필터링하고 시각화할 수 있었을 것 같습니다.

- **데이터 분석 미흡:**  
  **데이터 구조에 대한 이해와 분석이 다소 부족해**, 원하는 결과를 얻는 데 어려움이 있었습니다.
